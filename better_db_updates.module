<?php

/**
 * @file
 * Core functions for the Better db Update API module.
 */

/**
 * Implements hook_batch_alter().
 */
function better_db_updates_batch_alter(&$batch) {
  foreach ($batch['sets'] as $set_id => $set) {
    // If batch is generated by 'drush updb' or update.php, ensure that the
    // Better DB Update hooks are always run.
    if (isset($set['finished']) && in_array($set['finished'], array('drush_update_finished', 'update_finished'))) {
      foreach ($set['operations'] as $operation_id => $operation) {
        if ($operation[1][0] == 'better_db_updates' && $operation[1][1] == 7000) {
          $batch['sets'][$set_id]['operations'][$operation_id][0] = 'better_db_updates_update_7000';
        }
      }
    }
  }
}

/**
 * Implements hook_better_db_updates_directory().
 */
function better_db_updates_better_db_updates_directory() {
  return 'updates';
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function better_db_updates_form_update_script_selection_form_alter(&$form, &$form_state, $form_id) {
  $count = str_replace(' pending updates', '', $form['start']['#title']);
  $count = str_replace(' pending update', '', $count) - 1;

  unset($form['start']['better_db_updates_updates']);

  $directories = array();

  foreach (module_implements('better_db_updates_directory') as $module) {
    $function = $module . '_better_db_updates_directory';
    $result = $function();
    if ($result && is_string($result)) {
      $directories[$module] = drupal_get_path('module', $module) . '/' . $result;
    }
  }

  $all_files = array();

  $extension = 'inc';
  foreach ($directories as $module => $path) {
    $all_files[$module] = file_scan_directory($path, '/\.' . $extension . '$/', array('key' => 'name'));
  }

  foreach ($all_files as $module => $updates) {
    $items = array();

    foreach ($updates as $key => $info) {
      if (empty(db_select('better_db_updates', 'b')->fields('b', array())->condition('module_name', $module)->condition('update_filename', $info->name)->execute()->fetchAll())) {
        $items[$key] = 'Update ' . $key;
        $count++;
      }
    }

    if (!empty($items)) {
      $form['start'][$module . '_updates'] = array(
        '#theme' => 'item_list',
        '#items' => $items,
        '#title' => $module . ' module',
      );
    }
  }

  if ($count > 0) {
    $form['start']['#title'] = format_plural($count, '1 pending update', '@count pending updates');
  }
  else {
    drupal_set_message(t('No pending updates.'));
    unset($form['start']);
    unset($form['help']);
    unset($form['actions']);
  }
}
